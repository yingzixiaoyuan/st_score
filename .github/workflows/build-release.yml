name: Build Student Score Analyzer Desktop App & Release

on:
  push:
    tags:
      - "v*.*.*"
    branches:
      - main
      - new
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  build:
    runs-on: ${{ matrix.os-target.os }}
    strategy:
      matrix:
        os-target:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Cache pip dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller pillow

      - name: Generate all application icons
        run: |
          cd build_assets
          python universal_icon_generator.py
          ls -la *.ico *.png *.icns || true
          ls -la ../tauri/src-tauri/icons/ || true

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          target: ${{ matrix.os-target.target }}

      # onedir mode doesn't work with ubuntu, build_appimage.sh fails
      - name: Create Python executable for tauri (Ubuntu)
        if: matrix.os-target.os == 'ubuntu-latest'
        run: |
          pyinstaller entrypoint.onefile.spec
          cp dist/entrypoint ./tauri/src-tauri/binaries/st_score_analyzer-${{ matrix.os-target.target }}

      - name: Create Python executable for tauri (Windows)
        if: matrix.os-target.os == 'windows-latest'
        run: |
          pyinstaller entrypoint.spec
          cp dist/entrypoint/entrypoint.exe ./tauri/src-tauri/binaries/st_score_analyzer-${{ matrix.os-target.target }}.exe
          cp -r dist/entrypoint/_internal ./tauri/src-tauri/binaries/

      # onedir mode doesn't work with macos due to missing Python framework
      - name: Create Python executable for tauri (macOS)
        if: matrix.os-target.os == 'macos-latest'
        run: |
          pyinstaller entrypoint.onefile.spec
          cp dist/entrypoint ./tauri/src-tauri/binaries/st_score_analyzer-${{ matrix.os-target.target }}

      - name: Install tauri dependencies (Ubuntu)
        if: matrix.os-target.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y javascriptcoregtk-4.1 libsoup-3.0 webkit2gtk-4.1

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.0.6
          run_install: false

      - name: Install tauri frontend dependencies
        working-directory: tauri
        run: pnpm install

      - name: Build tauri desktop app
        working-directory: tauri
        run: pnpm tauri build -t ${{ matrix.os-target.target }}

      - name: Upload Tauri artifacts
        id: artifact_upload
        uses: actions/upload-artifact@v4
        with:
          name: st_score_analyzer-${{ matrix.os-target.target }}
          path: |
            tauri/src-tauri/target/${{ matrix.os-target.target }}/release/bundle/deb/
            tauri/src-tauri/target/${{ matrix.os-target.target }}/release/bundle/nsis/
            tauri/src-tauri/target/${{ matrix.os-target.target }}/release/bundle/dmg/
            tauri/src-tauri/target/${{ matrix.os-target.target }}/release/bundle/appimage/
          compression-level: 9

  create_release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
          merge-multiple: true

      - name: List artifacts
        run: |
          find ./artifacts -type f -exec ls -la {} \;

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create release notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          ## ğŸ“Š å­¦ç”Ÿæˆç»©åˆ†æå™¨æ¡Œé¢åº”ç”¨ v${{ steps.get_version.outputs.VERSION }}
          
          ### âœ¨ åŠŸèƒ½ç‰¹æ€§
          - ğŸ“Š **æ•°æ®å¯¼å…¥åˆ†æ**: æ”¯æŒExcelæ–‡ä»¶å¯¼å…¥ï¼Œè‡ªåŠ¨è§£æå­¦ç”Ÿæˆç»©æ•°æ®
          - ğŸ“ˆ **å¤šç»´åº¦ç»Ÿè®¡**: æä¾›ä¸°å¯Œçš„å›¾è¡¨å±•ç¤ºï¼ŒåŒ…æ‹¬åˆ†æ•°åˆ†å¸ƒã€è¶‹åŠ¿åˆ†æç­‰
          - ğŸ¨ **è‡ªå®šä¹‰é…ç½®**: æ”¯æŒé¢œè‰²ä¸»é¢˜è®¾ç½®ï¼Œä¸ªæ€§åŒ–ç•Œé¢æ˜¾ç¤º
          - ğŸ“š **å†å²ç®¡ç†**: å®Œæ•´çš„æ•°æ®å†å²è®°å½•ï¼Œæ–¹ä¾¿è¿½è¸ªå’Œå¯¹æ¯”
          - ğŸ–¥ï¸ **åŸç”Ÿæ¡Œé¢åº”ç”¨**: åŸºäºTauriæ„å»ºï¼Œå¯åŠ¨å¿«é€Ÿï¼Œèµ„æºå ç”¨ä½
          - ğŸŒ **å†…ç½®Webç•Œé¢**: é›†æˆStreamlitåº”ç”¨ï¼Œæä¾›ç›´è§‚çš„æ“ä½œç•Œé¢
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          
          #### Windows ç”¨æˆ·
          - ä¸‹è½½ï¼š`å­¦ç”Ÿæˆç»©åˆ†æå™¨_x.x.x_x64-setup.exe` (å®‰è£…åŒ…)
          - æˆ–ä¸‹è½½ï¼š`å­¦ç”Ÿæˆç»©åˆ†æå™¨_x.x.x_x64.msi` (MSIå®‰è£…åŒ…)
          - åŒå‡»å®‰è£…åå³å¯ä½¿ç”¨
          
          #### macOS ç”¨æˆ·  
          - **Intel Mac**: ä¸‹è½½ `.dmg` æ–‡ä»¶ï¼Œæ‹–æ‹½åˆ°Applicationsæ–‡ä»¶å¤¹
          - **Apple Silicon Mac**: ä¸‹è½½å¯¹åº”çš„ `.dmg` æ–‡ä»¶
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦åœ¨"ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§"ä¸­å…è®¸è¿è¡Œ
          
          #### Linux ç”¨æˆ·
          - **Ubuntu/Debian**: ä¸‹è½½ `.deb` æ–‡ä»¶ï¼Œä½¿ç”¨ `sudo dpkg -i *.deb` å®‰è£…
          - **é€šç”¨Linux**: ä¸‹è½½ `.AppImage` æ–‡ä»¶ï¼Œæ·»åŠ æ‰§è¡Œæƒé™åç›´æ¥è¿è¡Œ
          
          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. å¯åŠ¨åº”ç”¨ç¨‹åº
          2. ç­‰å¾…å¯åŠ¨ç”»é¢åŠ è½½å®Œæˆ
          3. åº”ç”¨ä¼šè‡ªåŠ¨æ‰“å¼€å†…ç½®çš„Webç•Œé¢
          4. å¼€å§‹å¯¼å…¥å’Œåˆ†æå­¦ç”Ÿæˆç»©æ•°æ®
          
          ### ğŸ”§ æŠ€æœ¯æ¶æ„
          - **å‰ç«¯**: Tauri + TypeScript + Vite
          - **åç«¯**: Python + Streamlit + SQLite
          - **æ‰“åŒ…**: è·¨å¹³å°åŸç”Ÿåº”ç”¨ï¼Œæ— éœ€æµè§ˆå™¨ä¾èµ–
          
          ---
          
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨GitHub Issuesä¸­åé¦ˆã€‚
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          name: å­¦ç”Ÿæˆç»©åˆ†æå™¨æ¡Œé¢åº”ç”¨ v${{ steps.get_version.outputs.VERSION }}
          body_path: RELEASE_NOTES.md
          files: ./artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
